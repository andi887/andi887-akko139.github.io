
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>data market</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      padding: 16px;
      line-height: 1.5;
    }
    .back-btn {
      display: inline-block;
      margin-bottom: 16px;
      padding: 10px 20px;
      background: #2ecc71;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .back-btn:hover {
      background: #27ae60;
    }
    .feature-label {
      text-align: center;
      font-weight: bold;
      margin-bottom: 15px;
      color: #2c3e50;
      font-size: 1.3em;
    }
    .market-section {
      margin-bottom: 30px;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .market-section h2 {
      text-align: center;
      margin-top: 0;
      font-size: 1.2em;
      color: #333;
    }
    .table-container {
      overflow-x: auto;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      margin-bottom: 10px;
      border-radius: 4px;
    }
    table {
      width: 100%;
      min-width: 920px;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 0.9em;
    }
    th {
      background-color: #f2f2f9;
      position: sticky;
      top: 0;
    }
    input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      text-align: center;
      border: 1px solid transparent;
      outline: none;
      padding: 6px;
      transition: border-color 0.3s;
    }
    input[type="text"]:focus {
      border-color: #2196F3;
      background-color: #f9f9f9;
    }
    .controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    button {
      padding: 8px 14px;
      font-size: 0.9em;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.1s;
    }
    button:active {
      transform: scale(0.98);
    }
    .save-btn { background-color: #4CAF50; color: white; }
    .edit-btn { background-color: #2196F3; color: white; }
    .add-row-btn { background-color: #FF9800; color: white; }
    .delete-btn {
      background-color: #f44336;
      color: white;
      padding: 4px 8px;
      font-size: 0.8em;
    }
    .input-error { color: red; font-weight: bold; }
    #status {
      text-align: center;
      margin: 10px 0;
      font-weight: bold;
      min-height: 24px;
    }
    .success { color: #4CAF50; }
    .error { color: #f44336; }
    @media (max-width: 600px) {
      .controls { flex-direction: column; align-items: center; }
      button { width: 100%; max-width: 200px; }
    }
  </style>
</head>
<body>
  <a href="index.html" class="back-btn">← Kembali ke Beranda</a>
  <div class="feature-label">data market</div>
  <div id="status"></div>
  <div id="fitur1-container"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyALc-1SYjzRUcB-Ws01rab1mxlmcv2e6dA",
      authDomain: "nomoromosse.firebaseapp.com",
      databaseURL: "https://nomoromosse-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "nomoromosse",
      storageBucket: "nomoromosse.firebasestorage.app",
      messagingSenderId: "985183830784",
      appId: "1:985183830784:web:fae21bdb94c1f0103769e5"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // === HEADER DIPERBARUI: TAMBAH "tgl" ===
    const TABLE_HEADERS = ["tgl", "res", "B", "C", "D", "G", "H", "I", "J", "K", "R", "Y", "A", "M", "N", "L"];
    const ACTION_HEADER = "Aksi";

    // === KONSTANTA KONTROL (TIDAK BERUBAH) ===
    const KONTROL_B = {1:["1","2","6","7","8","9"],2:["0","2","3","7","8","9"],3:["0","1","3","4","8","9"],4:["0","1","2","4","5","9"],5:["0","1","2","3","5","6"],6:["1","2","3","4","6","7"],7:["2","3","4","5","7","8"],8:["3","4","5","6","8","9"],9:["0","4","5","6","7","9"],0:["1","2","3","4","5","6"]};
    const KONTROL_C = {0:["3","4","5","6","8","9"],1:["0","2","3","4","6","9"],2:["1","2","3","5","6","8"],3:["0","1","2","3","4","9"],4:["1","2","3","6","8","9"],5:["0","1","2","3","4","5","9"],6:["0","2","3","5","6","9"],7:["0","1","2","3","8","9"],8:["2","3","4","6","7","9"],9:["1","2","3","4","5","6"]};
    const KONTROL_G = {0:["0","1","2","7","8","9"],1:["0","1","2","3","8","9"],2:["0","1","2","3","4","9"],3:["0","1","2","3","4","5"],4:["1","2","3","4","5","6"],5:["2","3","4","5","6","7"],6:["3","4","5","6","7","8"],7:["4","5","6","7","8","9"],8:["5","6","7","8","9","0"],9:["6","7","8","9","0","1"]};
    const KONTROL_H = {0:["0","1","2","5","6","7"],1:["1","2","3","6","7","8"],2:["2","3","4","7","8","9"],3:["0","3","4","5","8","9"],4:["0","2","4","5","6","9"],5:["0","1","2","5","6","7"],6:["1","2","3","6","7","8"],7:["2","3","4","7","8","9"],8:["0","3","4","5","8","9"],9:["0","1","4","5","6","9"]};
    const KONTROL_I = {0:["0","2","3","5","6","7"],1:["0","3","4","6","7","9"],2:["0","1","5","6","7","8"],3:["2","5","6","7","8","9"],4:["0","2","3","5","6","7"],5:["0","1","4","7","8","9"],6:["0","1","2","7","8","9"],7:["0","1","2","3","6","9"],8:["0","1","2","3","4","5"],9:["0","3","4","5","7","8"]};
    const KONTROL_J = {0:["4","5","6","7","8","9"],1:["5","6","7","8","9","0"],2:["6","7","8","9","0","1"],3:["7","8","9","0","1","2"],4:["8","9","0","1","2","3"],5:["9","0","1","2","3","4"],6:["0","1","2","3","4","5"],7:["1","2","3","4","5","6"],8:["2","3","4","5","6","7"],9:["3","4","5","6","7","8"]};
    const KONTROL_K = {0:["0","3","4","5","6","9"],1:["0","1","4","5","6","7"],2:["1","2","5","6","7","8"],3:["2","3","6","7","8","9"],4:["0","3","4","7","8","9"],5:["0","1","4","5","8","9"],6:["0","1","2","5","6","9"],7:["0","1","2","3","6","7"],8:["1","2","3","4","7","8"],9:["2","3","4","5","8","9"]};
    const KONTROL_R = {0:["5","6","7","8","9","0"],1:["1","2","3","4","5","6"],2:["7","8","9","0","1","2"],3:["3","4","5","6","7","8"],4:["9","0","1","2","3","4"],5:["5","6","7","8","9","0"],6:["1","2","3","4","5","6"],7:["7","8","9","0","1","2"],8:["3","4","5","6","7","8"],9:["9","0","1","2","3","4"]};
    const KONTROL_Y = {0:["8","9","0","1","2","3"],1:["9","0","1","2","3","4"],2:["0","1","2","3","4","5"],3:["1","2","3","4","5","6"],4:["2","3","4","5","6","7"],5:["3","4","5","6","7","8"],6:["4","5","6","7","8","9"],7:["5","6","7","8","9","0"],8:["6","7","8","9","0","1"],9:["7","8","9","0","1","2"]};
    const KONTROL_A = {1:["0","1","3","6","7"],2:["1","2","3","7","8"],3:["2","3","4","8","9"],4:["0","3","4","5","9"],5:["0","1","4","5","6"],6:["1","2","5","6","7"],7:["2","3","6","7","8"],8:["3","4","7","8","9"],9:["0","4","5","8","9"]};
    const KONTROL_M = {0:["9","0","1","2","3"],1:["8","9","0","1","2"],2:["3","4","5","6","7"],3:["3","4","5","6","7"],4:["5","6","7","8","9"],5:["0","1","2","3","4"],6:["7","8","9","0","1"],7:["2","3","4","5","6"],8:["1","2","3","4","5"],9:["4","5","6","7","8"]};
    const KONTROL_N = {0:["1","4","6","9"],1:["0","2","5","7"],2:["1","3","6","8"],3:["2","4","7","9"],4:["0","3","5","8"],5:["6","4","1","9"],6:["7","5","0","2"],7:["8","6","3","1"],8:["9","7","4","2"],9:["0","8","5","3"]};

    // === FUNGSI PERHITUNGAN (TIDAK BERUBAH) ===
    function calculateKontrolB(resSourceValue, resTargetValue) {
      if (!/^\d+$/.test(resSourceValue) || resSourceValue.length < 2 || !/^\d+$/.test(resTargetValue) || resTargetValue.length < 2) {
        return { value: "", isError: false };
      }
      const twoDigitsSource = resSourceValue.slice(-2);
      const d1s = twoDigitsSource[0];
      const d2s = twoDigitsSource[1];
      const sum = parseInt(d1s) + parseInt(d2s);
      let dasar = (sum === 10) ? 1 : (sum % 10);
      const kontrolList = KONTROL_B[dasar];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    function calculateKontrolC(resSourceValue, resTargetValue) {
      const kepalaSource = resSourceValue[2];
      const kontrolList = KONTROL_C[kepalaSource];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    function calculateKontrolD(resSourceValue, resTargetValue) {
      if (!/^\d+$/.test(resSourceValue) || resSourceValue.length < 3 || !/^\d+$/.test(resTargetValue) || resTargetValue.length < 2) {
        return { value: "", isError: false };
      }
      const kop = resSourceValue[1];
      const kepala = resSourceValue[2];
      const sum = parseInt(kop) + parseInt(kepala);
      let dasar = (sum === 10) ? 1 : (sum % 10);
      const kontrolList = KONTROL_B[dasar];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    function calculateKontrolG(resSourceValue, resTargetValue) {
      if (!/^\d+$/.test(resSourceValue) || resSourceValue.length < 3 || !/^\d+$/.test(resTargetValue) || resTargetValue.length < 2) {
        return { value: "", isError: false };
      }
      const kop = resSourceValue[1];
      const kepala = resSourceValue[2];
      const sum = parseInt(kop) + parseInt(kepala);
      let dasar = (sum === 10) ? 1 : (sum % 10);
      const kontrolList = KONTROL_G[dasar];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    function calculateKontrolH(resSourceValue, resTargetValue) {
      if (!/^\d+$/.test(resSourceValue) || resSourceValue.length < 3 || !/^\d+$/.test(resTargetValue) || resTargetValue.length < 2) {
        return { value: "", isError: false };
      }
      const kepalaSource = resSourceValue[2];
      const kontrolList = KONTROL_H[kepalaSource];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    function calculateKontrolI(resSourceValue, resTargetValue) {
      if (!/^\d+$/.test(resSourceValue) || resSourceValue.length < 1 || !/^\d+$/.test(resTargetValue) || resTargetValue.length < 2) {
        return { value: "", isError: false };
      }
      const ekorSource = resSourceValue[resSourceValue.length - 1];
      const kontrolList = KONTROL_I[ekorSource];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    function calculateKontrolJ(resSourceValue, resTargetValue) {
      if (!/^\d+$/.test(resSourceValue) || resSourceValue.length < 2 || !/^\d+$/.test(resTargetValue) || resTargetValue.length < 2) {
        return { value: "", isError: false };
      }
      const as = parseInt(resSourceValue[0]);
      const ekor = parseInt(resSourceValue[resSourceValue.length - 1]);
      const dasar = (as + ekor) % 10;
      const kontrolList = KONTROL_J[dasar];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    function calculateKontrolK(resSourceValue, resTargetValue) {
      if (!/^\d+$/.test(resSourceValue) || resSourceValue.length < 3 || !/^\d+$/.test(resTargetValue) || resTargetValue.length < 2) {
        return { value: "", isError: false };
      }
      const kepala = parseInt(resSourceValue[2]);
      const ekor = parseInt(resSourceValue[resSourceValue.length - 1]);
      const dasar = (kepala + ekor) % 10;
      const kontrolList = KONTROL_K[dasar];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    function calculateKontrolR(resSourceValue, resTargetValue) {
      if (!/^\d+$/.test(resSourceValue) || resSourceValue.length < 1 || !/^\d+$/.test(resTargetValue) || resTargetValue.length < 2) {
        return { value: "", isError: false };
      }
      const ekorSource = resSourceValue[resSourceValue.length - 1];
      const kontrolList = KONTROL_R[ekorSource];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    function calculateKontrolY(resSourceValue, resTargetValue) {
      if (!/^\d+$/.test(resSourceValue) || resSourceValue.length < 2 || !/^\d+$/.test(resTargetValue) || resTargetValue.length < 2) {
        return { value: "", isError: false };
      }
      const kop = parseInt(resSourceValue[1]);
      const ekor = parseInt(resSourceValue[resSourceValue.length - 1]);
      const dasar = (kop + ekor) % 10;
      const kontrolList = KONTROL_Y[dasar];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    function calculateKontrolA(resSourceValue, resTargetValue) {
      if (!/^\d+$/.test(resSourceValue) || resSourceValue.length < 3 || !/^\d+$/.test(resTargetValue) || resTargetValue.length < 2) {
        return { value: "", isError: false };
      }
      const kepala = parseInt(resSourceValue[2]);
      const ekor = parseInt(resSourceValue[resSourceValue.length - 1]);
      let dasar = kepala + ekor;
      while (dasar >= 10) dasar = Math.floor(dasar / 10) + (dasar % 10);
      const kontrolList = KONTROL_A[dasar];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    function calculateKontrolM(resSourceValue, resTargetValue) {
      if (!/^\d+$/.test(resSourceValue) || resSourceValue.length < 1 || !/^\d+$/.test(resTargetValue) || resTargetValue.length < 2) {
        return { value: "", isError: false };
      }
      const ekorSource = resSourceValue[resSourceValue.length - 1];
      const kontrolList = KONTROL_M[ekorSource];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    function calculateKontrolN(resSourceValue, resTargetValue) {
      if (!/^\d+$/.test(resSourceValue) || resSourceValue.length < 3 || !/^\d+$/.test(resTargetValue) || resTargetValue.length < 2) {
        return { value: "", isError: false };
      }
      const kepala = parseInt(resSourceValue[2]);
      const ekor = parseInt(resSourceValue[resSourceValue.length - 1]);
      const dasar = Math.abs(kepala - ekor);
      const kontrolList = KONTROL_N[dasar];
      if (!kontrolList) return { value: "", isError: false };
      const twoDigitsTarget = resTargetValue.slice(-2);
      const d1t = twoDigitsTarget[0];
      const d2t = twoDigitsTarget[1];
      const resultDigits = [];
      [d1t, d2t].forEach(digit => {
        if (kontrolList.includes(digit)) resultDigits.push(digit);
      });
      if (resultDigits.length > 0) return { value: resultDigits.join(''), isError: false };
      else return { value: "X", isError: true };
    }

    // === UTILITAS FORMAT TANGGAL ===
    function formatTanggalInput(inputElement) {
      inputElement.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, ''); // hanya angka
        if (value.length > 4) value = value.slice(0, 4);
        if (value.length >= 2) {
          value = value.slice(0, 2) + '/' + value.slice(2);
        }
        e.target.value = value;
      });
    }

    // === LOGIKA TABEL ===
    function calculateRow(targetRow) {
      const tbody = targetRow.parentElement;
      const allRows = Array.from(tbody.querySelectorAll('tr'));
      const targetIndex = allRows.indexOf(targetRow);
      const sourceIndex = (targetIndex === 0) ? 0 : targetIndex - 1;
      const sourceRow = allRows[sourceIndex];
      if (targetIndex === 0 && !sourceRow?.querySelectorAll('td input')[1]?.value) return;
      if (!sourceRow) return;

      const resSourceValue = sourceRow.querySelectorAll('td input')[1]?.value || '';
      const resTargetValue = targetRow.querySelectorAll('td input')[1]?.value || '';

      const inputs = targetRow.querySelectorAll('td input');
      if (inputs.length < 16) return;

      const bResult = calculateKontrolB(resSourceValue, resTargetValue);
      inputs[2].value = bResult.value;
      inputs[2].classList.toggle('input-error', bResult.isError);

      const cResult = calculateKontrolC(resSourceValue, resTargetValue);
      inputs[3].value = cResult.value;
      inputs[3].classList.toggle('input-error', cResult.isError);

      const dResult = calculateKontrolD(resSourceValue, resTargetValue);
      inputs[4].value = dResult.value;
      inputs[4].classList.toggle('input-error', dResult.isError);

      const gResult = calculateKontrolG(resSourceValue, resTargetValue);
      inputs[5].value = gResult.value;
      inputs[5].classList.toggle('input-error', gResult.isError);

      const hResult = calculateKontrolH(resSourceValue, resTargetValue);
      inputs[6].value = hResult.value;
      inputs[6].classList.toggle('input-error', hResult.isError);

      const iResult = calculateKontrolI(resSourceValue, resTargetValue);
      inputs[7].value = iResult.value;
      inputs[7].classList.toggle('input-error', iResult.isError);

      const jResult = calculateKontrolJ(resSourceValue, resTargetValue);
      inputs[8].value = jResult.value;
      inputs[8].classList.toggle('input-error', jResult.isError);

      const kResult = calculateKontrolK(resSourceValue, resTargetValue);
      inputs[9].value = kResult.value;
      inputs[9].classList.toggle('input-error', kResult.isError);

      const rResult = calculateKontrolR(resSourceValue, resTargetValue);
      inputs[10].value = rResult.value;
      inputs[10].classList.toggle('input-error', rResult.isError);

      const yResult = calculateKontrolY(resSourceValue, resTargetValue);
      inputs[11].value = yResult.value;
      inputs[11].classList.toggle('input-error', yResult.isError);

      const aResult = calculateKontrolA(resSourceValue, resTargetValue);
      inputs[12].value = aResult.value;
      inputs[12].classList.toggle('input-error', aResult.isError);

      const mResult = calculateKontrolM(resSourceValue, resTargetValue);
      inputs[13].value = mResult.value;
      inputs[13].classList.toggle('input-error', mResult.isError);

      const nResult = calculateKontrolN(resSourceValue, resTargetValue);
      inputs[14].value = nResult.value;
      inputs[14].classList.toggle('input-error', nResult.isError);
    }

    function recalculateFrom(startingRow) {
      const tbody = startingRow.parentElement;
      const allRows = Array.from(tbody.querySelectorAll('tr'));
      const startIndex = allRows.indexOf(startingRow);
      for (let i = startIndex; i < allRows.length; i++) {
        calculateRow(allRows[i]);
      }
    }

    function createRow() {
      const tr = document.createElement("tr");
      TABLE_HEADERS.forEach(() => {
        const td = document.createElement("td");
        const input = document.createElement("input");
        input.type = "text";
        input.setAttribute('autocomplete', 'off');
        td.appendChild(input);
        tr.appendChild(td);
      });
      const actionTd = document.createElement("td");
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Hapus";
      deleteBtn.className = "delete-btn";
      deleteBtn.addEventListener('click', function () {
        if (confirm("Hapus baris ini?")) {
          const row = this.closest('tr');
          const next = row.nextElementSibling;
          row.remove();
          if (next) recalculateFrom(next);
          const tableId = row.closest('table').id;
          saveDataToFirebase(tableId);
        }
      });
      actionTd.appendChild(deleteBtn);
      tr.appendChild(actionTd);

      const inputs = tr.querySelectorAll('input');
      formatTanggalInput(inputs[0]);
      inputs[0].maxLength = 5;
      inputs[0].placeholder = "DD/MM";
      inputs[1].placeholder = "4D";

      tr.addEventListener('input', () => {
        const tableId = tr.closest('table').id;
        recalculateFrom(tr);
        saveDataToFirebase(tableId);
      });

      return tr;
    }

    function addRow(tableId) {
      const tbody = document.getElementById(tableId).querySelector("tbody");
      const newRow = createRow();
      tbody.appendChild(newRow);
      calculateRow(newRow);
      saveDataToFirebase(tableId);
    }

    // === FIREBASE ===
    function showStatus(msg, isSuccess = true) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = msg;
      statusEl.className = isSuccess ? 'success' : 'error';
      setTimeout(() => statusEl.textContent = '', 3000);
    }

    async function saveDataToFirebase(tableId) {
      try {
        const table = document.getElementById(tableId);
        const rows = Array.from(table.querySelectorAll("tbody tr"));
        const data = rows.map(row => Array.from(row.querySelectorAll("input")).map(inp => inp.value));
        await set(ref(database, `data-market/${tableId}`), data);
        showStatus(`✓ ${tableId} disimpan`, true);
      } catch (error) {
        console.error("Gagal simpan ke Firebase:", error);
        showStatus("✗ Gagal menyimpan", false);
      }
    }

    async function loadDataFromFirebase(tableId) {
      const tbody = document.getElementById(tableId).querySelector("tbody");
      tbody.innerHTML = "";
      try {
        const snapshot = await get(ref(database, `data-market/${tableId}`));
        if (snapshot.exists()) {
          const data = snapshot.val();
          data.forEach(rowData => {
            let safeRowData = [...rowData];
            if (rowData.length === 15) {
              // Data lama: tidak ada kolom tgl
              safeRowData = ["", ...rowData];
            }
            if (safeRowData.length > 16) {
              safeRowData = safeRowData.slice(0, 16);
            }
            while (safeRowData.length < 16) {
              safeRowData.push("");
            }

            const tr = createRow();
            const inputs = tr.querySelectorAll("input");
            safeRowData.forEach((val, i) => {
              if (inputs[i]) inputs[i].value = val;
            });
            tbody.appendChild(tr);
          });
          const first = tbody.querySelector('tr');
          if (first) recalculateFrom(first);
        } else {
          addRow(tableId);
        }
      } catch (error) {
        console.error("Gagal muat ", error);
        showStatus("✗ Gagal memuat data", false);
        addRow(tableId);
      }
    }

    function initMarket(marketKey) {
      const container = document.createElement("div");
      container.className = "market-section";
      const title = document.createElement("h2");
      title.textContent = marketKey;
      container.appendChild(title);

      const tableContainer = document.createElement("div");
      tableContainer.className = "table-container";
      const table = document.createElement("table");
      table.id = marketKey;

      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      [...TABLE_HEADERS, ACTION_HEADER].forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      table.appendChild(tbody);
      tableContainer.appendChild(table);
      container.appendChild(tableContainer);

      const controls = document.createElement("div");
      controls.className = "controls";
      controls.appendChild(createButton("Simpan", "save-btn", () => saveDataToFirebase(marketKey)));
      controls.appendChild(createButton("Edit", "edit-btn", () => alert("Edit langsung di sel tabel.")));
      controls.appendChild(createButton("Tambah Baris", "add-row-btn", () => addRow(marketKey)));
      container.appendChild(controls);

      document.getElementById('fitur1-container').appendChild(container);
      loadDataFromFirebase(marketKey);
    }

    function createButton(text, className, onClickHandler) {
      const btn = document.createElement("button");
      btn.textContent = text;
      btn.className = className;
      btn.addEventListener('click', onClickHandler);
      return btn;
    }

    document.addEventListener("DOMContentLoaded", () => {
      const markets = ["Cambodia", "Sidney", "China", "Japan", "SGP", "Taiwan", "Hongkong", "Nusa"];
      markets.forEach(market => {
        initMarket(market);
      });
    });
  </script>
</body>
</html>
