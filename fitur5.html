<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ngai</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 15px;
      background: #f9f9f9;
      color: #333;
    }
    h1 {
      text-align: center;
      font-size: 1.4em;
      margin: 0 0 16px;
    }

    /* ðŸ”™ Kembali ke Beranda â€” inline style, konsisten dengan fitur2 & fitur4 */
    .back-home {
      text-align: center;
      margin: 12px 0;
    }
    .back-home a {
      display: inline-block;
      padding: 10px 20px;
      background: #4285f4;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-weight: bold;
      font-size: 0.95em;
    }
    .back-home a:hover {
      background: #3367d6;
    }

    .btn {
      width: 100%;
      padding: 12px;
      background: #673ab7;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin: 12px 0;
    }
    .result-box {
      background: white;
      padding: 12px;
      border-radius: 8px;
      margin-top: 15px;
      font-family: monospace;
      white-space: pre-wrap;
    }
    .section {
      margin-top: 16px;
    }
    .title {
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 6px;
    }
    .status {
      text-align: center;
      color: #e74c3c;
      min-height: 20px;
      margin: 8px 0;
    }
  </style>
</head>
<body>
  <h1>ðŸ”® ngai</h1>

  <!-- ðŸ”™ Kembali ke Beranda -->
  <div class="back-home">
    <a href="index.html">ðŸ”™ Kembali ke Beranda</a>
  </div>

  <button class="btn" id="btn-refresh">ðŸ”„ Muat & Gabungkan Data</button>
  <div class="status" id="status"></div>

  <div class="section">
    <div class="title">ðŸ“Œ Rangkuman NGAI (Angka yang Muncul di â‰¥2 Sumber)</div>
    <div class="result-box" id="ngai-result">Belum ada data. Silakan generate di fitur lain lalu refresh.</div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    // ðŸ”¹ Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyALc-1SYjzRUcB-Ws01rab1mxlmcv2e6dA",
      authDomain: "nomoromosse.firebaseapp.com",
      databaseURL: "https://nomoromosse-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "nomoromosse",
      storageBucket: "nomoromosse.firebasestorage.app",
      messagingSenderId: "985183830784",
      appId: "1:985183830784:web:fae21bdb94c1f0103769e5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const inputRef = ref(db, 'generator_2d/inputs');

    // ðŸ”¹ Konstanta
    const SHIO_TO_2D = {
      1: ["01","13","25","37","49","61","73","85","97"],
      2: ["02","14","26","38","50","62","74","86","98"],
      3: ["03","15","27","39","51","63","75","87","99"],
      4: ["04","16","28","40","52","64","76","88","00"],
      5: ["05","17","29","41","53","65","77","89"],
      6: ["06","18","30","42","54","66","78","90"],
      7: ["07","19","31","43","55","67","79","91"],
      8: ["08","20","32","44","56","68","80","92"],
      9: ["09","21","33","45","57","69","81","93"],
      10: ["10","22","34","46","58","70","82","94"],
      11: ["11","23","35","47","59","71","83","95"],
      12: ["12","24","36","48","60","72","84","96"]
    };

    const ALL_2D = Array.from({length:100}, (_,i) => i.toString().padStart(2,'0'));

    // ðŸ”¹ Helper
    function showMessage(msg) {
      document.getElementById('status').textContent = msg;
    }

    function parseDigitParts(input) {
      if (!input?.trim()) return [];
      return input
        .split('/')
        .map(s => s.trim().replace(/\D/g, ''))
        .filter(Boolean)
        .join('')
        .split('')
        .filter(d => d >= '0' && d <= '9');
    }

    function parseRange(rangeStr) {
      const clean = rangeStr?.trim() || '';
      if (!clean.includes('-')) return [];
      const [start, end] = clean.split('-').map(Number);
      if (isNaN(start) || isNaN(end)) return [];
      const res = [];
      for (let i = Math.max(0, start); i <= Math.min(99, end); i++) {
        res.push(i.toString().padStart(2, '0'));
      }
      return res;
    }

    function parseShioParts(input) {
      if (!input?.trim()) return [];
      return input
        .split('/')
        .map(s => parseInt(s.trim().replace(/\D/g, ''), 10))
        .filter(n => !isNaN(n) && n >= 1 && n <= 12);
    }

    function getShioNumbers(shio) {
      return SHIO_TO_2D[shio] || [];
    }

    // ðŸ”¹ Ambil Himpunan S dari Firebase (Fitur 3)
    function getHimpunanS(firebaseData) {
      if (!firebaseData) return new Set();

      const A = firebaseData.A || '';
      const B = firebaseData.B || '';
      const C = firebaseData.C || '';
      const D = firebaseData.D || '';
      const E = firebaseData.E || '';

      const ekorLemahSet = new Set();
      parseDigitParts(B).forEach(d => {
        for (let i = 0; i <= 9; i++) ekorLemahSet.add(i + '' + d);
      });

      const kepalaLemahSet = new Set();
      parseDigitParts(C).forEach(d => {
        for (let i = 0; i <= 9; i++) kepalaLemahSet.add(d + '' + i);
      });

      const jarakLemahSet = new Set(parseRange(D));
      const shioLemahSet = new Set();
      parseShioParts(E).forEach(s => getShioNumbers(s).forEach(n => shioLemahSet.add(n)));

      let versions = [];
      if (A.trim()) {
        versions = A.split('/').map(v => v.trim().replace(/\D/g, '')).filter(v => v);
      }
      const versionSets = versions.map(v => new Set(v.split('')));

      const hitCount = {};
      for (const num of ALL_2D) {
        let count = 0;
        if (ekorLemahSet.has(num)) count++;
        if (kepalaLemahSet.has(num)) count++;
        if (jarakLemahSet.has(num)) count++;
        if (shioLemahSet.has(num)) count++;
        for (const vs of versionSets) {
          if (!vs.has(num[0]) && !vs.has(num[1])) count++;
        }
        hitCount[num] = count;
      }

      // Himpunan S = Angka Bersih (count=0) + Angka Khusus (twin)
      const angkaBersih = ALL_2D.filter(num => hitCount[num] === 0);
      const twin = ALL_2D.filter(num => num[0] === num[1]);
      return new Set([...angkaBersih, ...twin]);
    }

    // ðŸ”¹ Ambil Himpunan R dari localStorage (Fitur 2: rampa40)
    function getHimpunanR() {
      const saved = localStorage.getItem('fitur2_data');
      if (!saved) return null;

      try {
        const data = JSON.parse(saved);
        if (!data.resultsHTML) return null;

        const temp = document.createElement('div');
        temp.innerHTML = data.resultsHTML;
        // Ambil bagian Rangkuman Final (biasanya bagian terakhir sebelum copy button)
        const sections = temp.querySelectorAll('.section');
        if (sections.length === 0) return null;

        // Cari bagian yang mengandung "Rangkuman Final"
        let finalSection = null;
        for (let sec of sections) {
          if (sec.querySelector('h2')?.textContent.includes('Rangkuman Final')) {
            finalSection = sec;
            break;
          }
        }
        if (!finalSection) {
          // fallback: ambil bagian terakhir
          finalSection = sections[sections.length - 1];
        }

        const valueDiv = finalSection.querySelector('.value');
        if (valueDiv) {
          let text = valueDiv.textContent.trim();
          if (text.endsWith('#')) text = text.slice(0, -1);
          const list = text.split('*').filter(x => x.length === 2);
          return new Set(list);
        }
      } catch (e) {
        console.error('Gagal ekstrak Himpunan R:', e);
      }
      return null;
    }

    // ðŸ”¹ Ambil Himpunan K dari localStorage (Fitur 4: kamar)
    function getHimpunanK() {
      const saved = localStorage.getItem('kamar_data');
      if (!saved) return null;

      try {
        const data = JSON.parse(saved);
        if (!data.hasil) return null;

        const kamarKuat = [];
        for (let k = 1; k <= 12; k++) {
          // Jika nilainya "â€”" atau kosong â†’ kamar kuat
          if (!data.hasil[k] || data.hasil[k] === "â€”") {
            kamarKuat.push(k);
          }
        }

        const himpunanK = new Set();
        kamarKuat.forEach(k => {
          const nums = SHIO_TO_2D[k] || [];
          nums.forEach(n => himpunanK.add(n));
        });
        return himpunanK;
      } catch (e) {
        console.error('Gagal ekstrak Himpunan K:', e);
      }
      return null;
    }

    // ðŸ”¹ Gabungkan & Filter (â‰¥2 sumber)
    function gabungkanDanFilter(R, S, K) {
      if (!R || !S || !K) {
        let msg = "âš ï¸ Data tidak lengkap:\n";
        if (!R) msg += "- Fitur 2 (rampa40)\n";
        if (!S) msg += "- Fitur 3 (saringan)\n";
        if (!K) msg += "- Fitur 4 (kamar)";
        return msg;
      }

      const count = {};
      for (const num of ALL_2D) count[num] = 0;

      R.forEach(n => count[n]++);
      S.forEach(n => count[n]++);
      K.forEach(n => count[n]++);

      const hasil = ALL_2D.filter(num => count[num] >= 2).sort();
      return hasil.length ? hasil.join('*') + '#' : "âŒ Tidak ada angka yang muncul di â‰¥2 sumber.";
    }

    // ðŸ”¹ Refresh utama
    async function refreshData() {
      showMessage("Mengambil data...");

      // Ambil data Firebase (Fitur 3)
      let firebaseData = null;
      try {
        const snapshot = await new Promise((resolve, reject) => {
          const timeout = setTimeout(() => reject(new Error("Timeout")), 5000);
          onValue(inputRef, (snap) => {
            clearTimeout(timeout);
            resolve(snap);
          }, (err) => {
            clearTimeout(timeout);
            reject(err);
          });
        });
        firebaseData = snapshot.val();
      } catch (err) {
        console.warn("Gagal ambil Firebase:", err);
      }

      const R = getHimpunanR();
      const S = getHimpunanS(firebaseData);
      const K = getHimpunanK();

      const hasil = gabungkanDanFilter(R, S, K);
      document.getElementById('ngai-result').textContent = hasil;
      showMessage("âœ… Data NGAI diperbarui.");
    }

    // ðŸ”¹ Event
    document.getElementById('btn-refresh').addEventListener('click', refreshData);

    // ðŸ”¹ Muat otomatis
    refreshData();
  </script>
</body>
</html>
