<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ngai</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 15px;
      background: #f9f9f9;
      color: #333;
    }
    h1 {
      text-align: center;
      font-size: 1.4em;
      margin: 0 0 16px;
    }

    .back-home {
      text-align: center;
      margin: 12px 0;
    }
    .back-home a {
      display: inline-block;
      padding: 10px 20px;
      background: #4285f4;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-weight: bold;
      font-size: 0.95em;
    }
    .back-home a:hover {
      background: #3367d6;
    }

    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin: 12px 0;
      font-weight: bold;
    }
    #btn-refresh { background: #673ab7; color: white; }
    #btn-ok { background: #4CAF50; color: white; display: none; }

    .result-box {
      background: white;
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      font-family: monospace;
      white-space: pre-wrap;
      border: 1px solid #ddd;
    }
    .section {
      margin-top: 16px;
    }
    .title {
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 6px;
      overflow: hidden; /* untuk tombol salin float:right */
    }
    .status {
      text-align: center;
      color: #e74c3c;
      min-height: 20px;
      margin: 8px 0;
    }
    #ngai-result {
      display: none;
      background: #e8f5e9;
      border-color: #4caf50;
    }
    .source-title {
      background: #f0f0f0;
      padding: 6px;
      border-radius: 4px;
      font-weight: bold;
      margin: 8px 0 4px;
    }

    /* Gaya tombol salin */
    .copy-btn {
      float: right;
      padding: 4px 8px;
      font-size: 0.85em;
      background: #e0e0e0;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      color: #333;
    }
    .copy-btn:hover {
      background: #d0d0d0;
    }
  </style>
</head>
<body>
  <h1>ğŸ”® ngai</h1>

  <div class="back-home">
    <a href="index.html">ğŸ”™ Kembali ke Beranda</a>
  </div>

  <button class="btn" id="btn-refresh">ğŸ”„ Muat Data dari Fitur 2, 3, 4</button>
  <button class="btn" id="btn-ok">âœ… OK â€“ Gabungkan & Tampilkan Hasil</button>
  <div class="status" id="status"></div>

  <!-- Tampilan sementara: 3 sumber -->
  <div id="preview-section" style="display:none;">
    <div class="source-title">ğŸ“Š Sumber Data</div>
    
    <div class="section">
      <div class="title">ğŸ”¹ Fitur 2 (rampa40) <button class="copy-btn" data-target="preview-r">ğŸ“‹ Salin</button></div>
      <div class="result-box" id="preview-r">-</div>
    </div>

    <div class="section">
      <div class="title">ğŸ”¹ Fitur 3 (saringan) <button class="copy-btn" data-target="preview-s">ğŸ“‹ Salin</button></div>
      <div class="result-box" id="preview-s">-</div>
    </div>

    <div class="section">
      <div class="title">ğŸ”¹ Fitur 4 (kamar) <button class="copy-btn" data-target="preview-k">ğŸ“‹ Salin</button></div>
      <div class="result-box" id="preview-k">-</div>
    </div>
  </div>

  <!-- Hasil akhir -->
  <div class="section">
    <div class="title">ğŸ“Œ Rangkuman NGAI (3-sumber + twin khusus) <button class="copy-btn" data-target="ngai-result">ğŸ“‹ Salin</button></div>
    <div class="result-box" id="ngai-result">Klik "OK" setelah data dimuat.</div>
  </div>

  <!-- Firebase SDK (tanpa spasi trailing!) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyALc-1SYjzRUcB-Ws01rab1mxlmcv2e6dA",
      authDomain: "nomoromosse.firebaseapp.com",
      databaseURL: "https://nomoromosse-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "nomoromosse",
      storageBucket: "nomoromosse.firebasestorage.app",
      messagingSenderId: "985183830784",
      appId: "1:985183830784:web:fae21bdb94c1f0103769e5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const inputRef = ref(db, 'generator_2d/inputs');

    const SHIO_TO_2D = {
      1: ["01","13","25","37","49","61","73","85","97"],
      2: ["02","14","26","38","50","62","74","86","98"],
      3: ["03","15","27","39","51","63","75","87","99"],
      4: ["04","16","28","40","52","64","76","88","00"],
      5: ["05","17","29","41","53","65","77","89"],
      6: ["06","18","30","42","54","66","78","90"],
      7: ["07","19","31","43","55","67","79","91"],
      8: ["08","20","32","44","56","68","80","92"],
      9: ["09","21","33","45","57","69","81","93"],
      10: ["10","22","34","46","58","70","82","94"],
      11: ["11","23","35","47","59","71","83","95"],
      12: ["12","24","36","48","60","72","84","96"]
    };

    const ALL_2D = Array.from({length:100}, (_,i) => i.toString().padStart(2,'0'));

    let cachedR = null;
    let cachedS = null;
    let cachedK = null;

    function showMessage(msg) {
      document.getElementById('status').textContent = msg;
    }

    // Fungsi salin ke clipboard
    async function copyToClipboard(text, feedbackId = 'status') {
      if (!text || text === '-' || text.startsWith('âŒ') || text.includes('Klik "OK"')) return;
      try {
        await navigator.clipboard.writeText(text);
        showMessage("âœ… Tersalin: " + (text.length > 30 ? text.substring(0,30) + "..." : text));
      } catch (err) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          showMessage("âœ… Tersalin (fallback)");
        } catch (ex) {
          showMessage("âŒ Gagal menyalin");
        }
        document.body.removeChild(textArea);
      }
    }

    // Event listener global untuk tombol salin
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('copy-btn')) {
        const targetId = e.target.getAttribute('data-target');
        const elem = document.getElementById(targetId);
        if (elem) {
          copyToClipboard(elem.textContent.trim());
        }
      }
    });

    // Fungsi parsing
    function parseDigitParts(input) {
      if (!input?.trim()) return [];
      return input.split('/').map(s => s.trim().replace(/\D/g, '')).filter(Boolean).join('').split('').filter(d => d >= '0' && d <= '9');
    }
    function parseRange(rangeStr) {
      const clean = rangeStr?.trim() || '';
      if (!clean.includes('-')) return [];
      const [start, end] = clean.split('-').map(Number);
      if (isNaN(start) || isNaN(end)) return [];
      const res = [];
      for (let i = Math.max(0, start); i <= Math.min(99, end); i++) {
        res.push(i.toString().padStart(2, '0'));
      }
      return res;
    }
    function parseShioParts(input) {
      if (!input?.trim()) return [];
      return input.split('/').map(s => parseInt(s.trim().replace(/\D/g, ''), 10)).filter(n => !isNaN(n) && n >= 1 && n <= 12);
    }
    function getShioNumbers(shio) { return SHIO_TO_2D[shio] || []; }

    function getHimpunanS(firebaseData) {
      if (!firebaseData) return new Set();
      const { A = '', B = '', C = '', D = '', E = '' } = firebaseData;
      const ekorLemahSet = new Set(); parseDigitParts(B).forEach(d => { for (let i = 0; i <= 9; i++) ekorLemahSet.add(i + '' + d); });
      const kepalaLemahSet = new Set(); parseDigitParts(C).forEach(d => { for (let i = 0; i <= 9; i++) kepalaLemahSet.add(d + '' + i); });
      const jarakLemahSet = new Set(parseRange(D));
      const shioLemahSet = new Set(); parseShioParts(E).forEach(s => getShioNumbers(s).forEach(n => shioLemahSet.add(n)));
      let versions = A.trim() ? A.split('/').map(v => v.trim().replace(/\D/g, '')).filter(v => v) : [];
      const versionSets = versions.map(v => new Set(v.split('')));
      const hitCount = {};
      for (const num of ALL_2D) {
        let count = 0;
        if (ekorLemahSet.has(num)) count++;
        if (kepalaLemahSet.has(num)) count++;
        if (jarakLemahSet.has(num)) count++;
        if (shioLemahSet.has(num)) count++;
        for (const vs of versionSets) if (!vs.has(num[0]) && !vs.has(num[1])) count++;
        hitCount[num] = count;
      }
      const angkaBersih = ALL_2D.filter(num => hitCount[num] === 0);
      const twin = ALL_2D.filter(num => num[0] === num[1]);
      return new Set([...angkaBersih, ...twin]);
    }

    function getHimpunanR() {
      const saved = localStorage.getItem('fitur2_data');
      if (!saved) return null;
      try {
        const data = JSON.parse(saved);
        if (!data.resultsHTML) return null;
        const temp = document.createElement('div');
        temp.innerHTML = data.resultsHTML;
        let finalSection = null;
        const sections = temp.querySelectorAll('.section');
        for (let sec of sections) {
          if (sec.querySelector('h2')?.textContent.includes('Rangkuman Final')) {
            finalSection = sec; break;
          }
        }
        if (!finalSection) finalSection = sections[sections.length - 1];
        const valueDiv = finalSection.querySelector('.value');
        if (valueDiv) {
          let text = valueDiv.textContent.trim();
          if (text.endsWith('#')) text = text.slice(0, -1);
          return new Set(text.split('*').filter(x => x.length === 2));
        }
      } catch (e) { console.error('Gagal ekstrak R:', e); }
      return null;
    }

    function getHimpunanK() {
      const saved = localStorage.getItem('kamar_data');
      if (!saved) return null;
      try {
        const data = JSON.parse(saved);
        if (!data.hasil) return null;
        const kamarKuat = [];
        for (let k = 1; k <= 12; k++) {
          if (!data.hasil[k] || data.hasil[k] === "â€”") {
            kamarKuat.push(k);
          }
        }
        const himpunanK = new Set();
        kamarKuat.forEach(k => { (SHIO_TO_2D[k] || []).forEach(n => himpunanK.add(n)); });
        return himpunanK;
      } catch (e) { console.error('Gagal ekstrak K:', e); }
      return null;
    }

    function formatSet(s) {
      return s && s.size > 0 ? Array.from(s).sort().join('*') + '#' : '-';
    }

    async function refreshData() {
      showMessage("Mengambil data...");

      let firebaseData = null;
      try {
        const snapshot = await new Promise((resolve, reject) => {
          const timeout = setTimeout(() => reject(new Error("Timeout")), 5000);
          onValue(inputRef, (snap) => { clearTimeout(timeout); resolve(snap); }, (err) => { clearTimeout(timeout); reject(err); });
        });
        firebaseData = snapshot.val();
      } catch (err) { console.warn("Firebase error:", err); }

      const R = getHimpunanR();
      const S = getHimpunanS(firebaseData);
      const K = getHimpunanK();

      cachedR = R;
      cachedS = S;
      cachedK = K;

      document.getElementById('preview-r').textContent = formatSet(R);
      document.getElementById('preview-s').textContent = formatSet(S);
      document.getElementById('preview-k').textContent = formatSet(K);

      document.getElementById('preview-section').style.display = 'block';
      document.getElementById('btn-ok').style.display = 'block';
      document.getElementById('ngai-result').style.display = 'none';
      document.getElementById('ngai-result').textContent = 'Klik "OK" untuk gabungkan.';

      showMessage("âœ… Data dimuat. Klik OK untuk proses.");
    }

    function processOk() {
      if (!cachedR || !cachedS || !cachedK) {
        document.getElementById('ngai-result').textContent = "âŒ Data tidak lengkap. Silakan refresh.";
        document.getElementById('ngai-result').style.display = 'block';
        return;
      }

      const count = {};
      for (const num of ALL_2D) count[num] = 0;
      cachedR.forEach(n => count[n]++);
      cachedS.forEach(n => count[n]++);
      cachedK.forEach(n => count[n]++);

      const isTwin = (num) => num[0] === num[1];

      // âœ¨ Logika baru: non-twin harus di 3 sumber, twin cukup di 1+
      const hasil = ALL_2D.filter(num => {
        if (isTwin(num)) {
          return count[num] >= 1; // twin: cukup muncul di 1 sumber
        } else {
          return count[num] === 3; // non-twin: wajib di semua 3 sumber
        }
      }).sort();

      const text = hasil.length ? hasil.join('*') + '#' : "âŒ Tidak ada angka yang memenuhi kriteria.";

      document.getElementById('ngai-result').textContent = text;
      document.getElementById('ngai-result').style.display = 'block';
      showMessage("âœ… Hasil NGAI (3-sumber + twin khusus) siap.");
    }

    document.getElementById('btn-refresh').addEventListener('click', refreshData);
    document.getElementById('btn-ok').addEventListener('click', processOk);

    refreshData();
  </script>
</body>
</html>
