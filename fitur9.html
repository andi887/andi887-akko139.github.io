<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dasar Lemah 2D</title>
  <style>
    /* ... (tetap gunakan style yang sama dari kode aslimu) ... */
  </style>

  <!-- ðŸ”¥ Gunakan Compat Mode seperti fitur1 -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
    // === Konfigurasi Firebase (sama di semua fitur) ===
    const firebaseConfig = {
      apiKey: "AIzaSyALc-1SYjzRUcB-Ws01rab1mxlmcv2e6dA",
      authDomain: "nomoromosse.firebaseapp.com",
      databaseURL: "https://nomoromosse-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "nomoromosse",
      storageBucket: "nomoromosse.appspot.com",
      messagingSenderId: "985183830784",
      appId: "1:985183830784:web:fae21bdb94c1f0103769e5"
    };

    // Initialize sekali
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const fitur9Ref = database.ref('fitur9');
  </script>
</head>
<body>
  <!-- ... (sama persis seperti struktur HTML aslimu) ... -->
  <!-- Ganti semua `window.db` dan `ref(window.db, ...)` dengan `database` -->
</body>

<script>
  // === RANDOM TERKENDALI (tetap sama) ===
  function SeededRandom(seed) {
    this.seed = seed % 2147483647;
    if (this.seed <= 0) this.seed += 2147483646;
  }
  SeededRandom.prototype.next = function() {
    return this.seed = this.seed * 16807 % 2147483647;
  };
  SeededRandom.prototype.random = function() {
    return (this.next() - 1) / 2147483646;
  };

  function generateFullWeakMap() {
    const weakMap = {};
    const seed = 12345;
    const rand = new SeededRandom(seed);
    for (let num = 0; num <= 99; num++) {
      let d1 = Math.floor(rand.random() * 9) + 1;
      let d2 = Math.floor(rand.random() * 9) + 1;
      if (d1 === d2) d2 = d1 === 9 ? 1 : d1 + 1;
      const key = num.toString().padStart(2, '0');
      weakMap[key] = [d1, d2];
    }
    weakMap['28'] = [3, 4];
    weakMap['82'] = [1, 2];
    return weakMap;
  }

  const fullWeakMap = generateFullWeakMap();
  let current2D = null;
  let savedData = {};

  // === GUNAKAN `database` (bukan window.db) ===
  function generateResult() {
    const input = document.getElementById('input2D').value.trim();
    if (!/^\d{1,2}$/.test(input)) {
      alert("Masukkan angka 2 digit (00â€“99).");
      return;
    }
    const key = input.padStart(2, '0');
    if (!(key in fullWeakMap)) {
      alert("Nomor harus antara 00â€“99.");
      return;
    }
    const [d1, d2] = savedData[key] || fullWeakMap[key];
    current2D = key;
    document.getElementById('show2D').textContent = key;
    document.getElementById('showDasar').textContent = `${d1} & ${d2}`;
    document.getElementById('resultBox').style.display = 'block';
    document.getElementById('input2D').value = key;
  }

  // === SIMPAN (pakai database.compat) ===
  function saveEntry() {
    if (!current2D) {
      alert("Tidak ada data untuk disimpan.");
      return;
    }
    const currentVal = savedData[current2D] || fullWeakMap[current2D];
    database.ref(`fitur9/${current2D}`).set(currentVal)
      .then(() => alert("Data tersimpan ke cloud."))
      .catch(e => {
        console.error(e);
        alert("Gagal menyimpan ke cloud.");
      });
  }

  function editEntry() {
    if (!current2D) {
      alert("Tidak ada data aktif.");
      return;
    }
    const newData = prompt(`Edit dasar lemah untuk ${current2D} (format: d1,d2)`);
    if (newData) {
      const parts = newData.split(',').map(p => p.trim());
      if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
        const [d1, d2] = parts.map(Number);
        if (d1 >= 1 && d1 <= 9 && d2 >= 1 && d2 <= 9 && d1 !== d2) {
          database.ref(`fitur9/${current2D}`).set([d1, d2])
            .then(() => alert("Data diperbarui di cloud."))
            .catch(e => {
              console.error(e);
              alert("Gagal memperbarui.");
            });
        } else {
          alert("Nilai harus angka 1â€“9 dan berbeda.");
        }
      } else {
        alert("Format salah. Gunakan: d1,d2");
      }
    }
  }

  function deleteEntry() {
    if (!current2D) {
      alert("Tidak ada data aktif.");
      return;
    }
    if (confirm(`Hapus data untuk ${current2D} dari cloud?`)) {
      database.ref(`fitur9/${current2D}`).remove()
        .then(() => {
          document.getElementById('resultBox').style.display = 'none';
          current2D = null;
          alert("Data dihapus dari cloud.");
        })
        .catch(e => {
          console.error(e);
          alert("Gagal menghapus.");
        });
    }
  }

  function useSaved(key) {
    current2D = key;
    const [d1, d2] = savedData[key] || fullWeakMap[key];
    document.getElementById('show2D').textContent = key;
    document.getElementById('showDasar').textContent = `${d1} & ${d2}`;
    document.getElementById('resultBox').style.display = 'block';
    document.getElementById('input2D').value = key;
  }

  function renderSavedList() {
    const container = document.getElementById('savedList');
    const keys = Object.keys(savedData).sort();
    let html = '<h3>Data Tersimpan</h3>';
    if (keys.length === 0) {
      html += '<p><em>Tidak ada data tersimpan di cloud.</em></p>';
    } else {
      html += '<div>';
      keys.forEach(key => {
        const [d1, d2] = savedData[key];
        html += `<div class="saved-item"><span><strong>${key}</strong>: ${d1} & ${d2}</span><button onclick="useSaved('${key}')" style="padding:4px 8px;font-size:12px;">Pakai</button></div>`;
      });
      html += '</div>';
    }
    container.innerHTML = html;
  }

  // === REALTIME LISTENER ===
  fitur9Ref.on('value', (snapshot) => {
    savedData = snapshot.val() || {};
    renderSavedList();
    if (current2D && document.getElementById('resultBox').style.display !== 'none') {
      const [d1, d2] = savedData[current2D] || fullWeakMap[current2D];
      document.getElementById('showDasar').textContent = `${d1} & ${d2}`;
    }
  }, (error) => {
    console.error("Firebase error:", error);
    document.getElementById('savedList').innerHTML = '<h3>Data Tersimpan</h3><p>Gagal memuat dari cloud.</p>';
  });

  // === GLOBAL ===
  window.generateResult = generateResult;
  window.saveEntry = saveEntry;
  window.editEntry = editEntry;
  window.deleteEntry = deleteEntry;
  window.useSaved = useSaved;

  // Tidak perlu cek window.db â€” database sudah siap sejak awal
  document.getElementById('input2D').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') generateResult();
  });
</script>
</body>
</html>
