<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>rampa40</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 15px;
      background: #f9f9f9;
      color: #333;
    }
    h1 {
      text-align: center;
      font-size: 1.4em;
      margin: 0 0 16px;
    }
    .back-home {
      text-align: center;
      margin: 12px 0;
    }
    .back-home a {
      display: inline-block;
      padding: 10px 20px;
      background: #4285f4;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-weight: bold;
      font-size: 0.95em;
    }
    .back-home a:hover {
      background: #3367d6;
    }
    .form-group {
      margin: 12px 0;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
      color: #2c3e50;
    }
    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1em;
      box-sizing: border-box;
    }
    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin: 12px 0;
      font-weight: bold;
      background: #4CAF50;
      color: white;
    }
    .btn:hover {
      background: #45a049;
    }
    .status {
      text-align: center;
      color: #e74c3c;
      min-height: 20px;
      margin: 8px 0;
      font-size: 0.95em;
    }
    .result-section {
      background: white;
      padding: 12px;
      border-radius: 8px;
      margin-top: 16px;
      border: 1px solid #ddd;
      font-family: monospace;
      white-space: pre-wrap;
    }
    .section-title {
      font-weight: bold;
      margin: 12px 0 6px;
      color: #2c3e50;
    }
  </style>
</head>
<body>
  <h1>üßÆ rampa40</h1>

  <div class="back-home">
    <a href="index.html">üîô Kembali ke Beranda</a>
  </div>

  <div class="form-group">
    <label for="market-select">Pilih Market</label>
    <select id="market-select">
      <option value="">-- Pilih Market --</option>
      <option value="sgp">SGP</option>
      <option value="taiwan">TAIWAN</option>
      <option value="hongkong">HONGKONG</option>
      <option value="sidney">SIDNEY</option>
      <option value="china">CHINA</option>
    </select>
  </div>

  <div class="form-group">
    <label for="prev-result">4D Result Sebelumnya</label>
    <input type="text" id="prev-result" placeholder="Contoh: 1234" maxlength="4" />
  </div>

  <div class="form-group">
    <label for="curr-result">4D Result Sekarang</label>
    <input type="text" id="curr-result" placeholder="Contoh: 5678" maxlength="4" />
  </div>

  <div class="form-group">
    <label for="prev-date">Tanggal Putaran Sebelumnya</label>
    <input type="text" id="prev-date" placeholder="Contoh: 17/12" />
  </div>

  <div class="form-group">
    <label for="curr-date">Tanggal Putaran Sekarang</label>
    <input type="text" id="curr-date" placeholder="Contoh: 18/12" />
  </div>

  <button class="btn" id="btn-generate">‚ñ∂Ô∏è Generate</button>
  <div class="status" id="status"></div>

  <div id="hasil-rampa40" style="display:none;">
    <div class="section-title">üìä Rangkuman Final</div>
    <div class="result-section" id="final-result">-</div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyALc-1SYjzRUcB-Ws01rab1mxlmcv2e6dA",
      authDomain: "nomoromosse.firebaseapp.com",
      databaseURL: "https://nomoromosse-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "nomoromosse",
      storageBucket: "nomoromosse.firebasestorage.app",
      messagingSenderId: "985183830784",
      appId: "1:985183830784:web:fae21bdb94c1f0103769e5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ‚îÄ‚îÄ‚îÄ KONSTANTA KONTROL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const KONTROL_B = {0:["5","6","7","8","9"],1:["6","7","8","9","0"],2:["7","8","9","0","1"],3:["8","9","0","1","2"],4:["9","0","1","2","3"],5:["0","1","2","3","4"],6:["1","2","3","4","5"],7:["2","3","4","5","6"],8:["3","4","5","6","7"],9:["4","5","6","7","8"]};
    const KONTROL_C = {0:["9","0","1","2","3"],1:["8","9","0","1","2"],2:["3","4","5","6","7"],3:["3","4","5","6","7"],4:["5","6","7","8","9"],5:["0","1","2","3","4"],6:["7","8","9","0","1"],7:["2","3","4","5","6"],8:["1","2","3","4","5"],9:["4","5","6","7","8"]};
    const KONTROL_D = {0:["9","0","1","2","3","4"],1:["8","9","0","1","2","3"],2:["7","8","9","0","1","2"],3:["6","7","8","9","0","1"],4:["5","6","7","8","9","0"],5:["4","5","6","7","8","9"],6:["3","4","5","6","7","8"],7:["2","3","4","5","6","7"],8:["1","2","3","4","5","6"],9:["0","1","2","3","4","5"]};
    const KONTROL_G = {0:["5","6","7","8","9","0"],1:["6","7","8","9","0","1"],2:["7","8","9","0","1","2"],3:["8","9","0","1","2","3"],4:["9","0","1","2","3","4"],5:["0","1","2","3","4","5"],6:["1","2","3","4","5","6"],7:["2","3","4","5","6","7"],8:["3","4","5","6","7","8"],9:["4","5","6","7","8","9"]};
    const KONTROL_H = {0:["0","1","2","3","4","5"],1:["1","2","3","4","5","6"],2:["2","3","4","5","6","7"],3:["3","4","5","6","7","8"],4:["4","5","6","7","8","9"],5:["5","6","7","8","9","0"],6:["6","7","8","9","0","1"],7:["7","8","9","0","1","2"],8:["8","9","0","1","2","3"],9:["9","0","1","2","3","4"]};
    const KONTROL_I = {0:["0","1","2","3","4"],1:["1","2","3","4","5"],2:["2","3","4","5","6"],3:["3","4","5","6","7"],4:["4","5","6","7","8"],5:["5","6","7","8","9"],6:["6","7","8","9","0"],7:["7","8","9","0","1"],8:["8","9","0","1","2"],9:["9","0","1","2","3"]};
    const KONTROL_J = {0:["0","1","2","3","4","5"],1:["1","2","3","4","5","6"],2:["2","3","4","5","6","7"],3:["3","4","5","6","7","8"],4:["4","5","6","7","8","9"],5:["5","6","7","8","9","0"],6:["6","7","8","9","0","1"],7:["7","8","9","0","1","2"],8:["8","9","0","1","2","3"],9:["9","0","1","2","3","4"]};
    const KONTROL_K = {0:["0","1","2","3","4","5"],1:["1","2","3","4","5","6"],2:["2","3","4","5","6","7"],3:["3","4","5","6","7","8"],4:["4","5","6","7","8","9"],5:["5","6","7","8","9","0"],6:["6","7","8","9","0","1"],7:["7","8","9","0","1","2"],8:["8","9","0","1","2","3"],9:["9","0","1","2","3","4"]};
    const KONTROL_R = {0:["0","1","2","3","4"],1:["1","2","3","4","5"],2:["2","3","4","5","6"],3:["3","4","5","6","7"],4:["4","5","6","7","8"],5:["5","6","7","8","9"],6:["6","7","8","9","0"],7:["7","8","9","0","1"],8:["8","9","0","1","2"],9:["9","0","1","2","3"]};
    const KONTROL_Y = {0:["0","1","2","3","4","5"],1:["1","2","3","4","5","6"],2:["2","3","4","5","6","7"],3:["3","4","5","6","7","8"],4:["4","5","6","7","8","9"],5:["5","6","7","8","9","0"],6:["6","7","8","9","0","1"],7:["7","8","9","0","1","2"],8:["8","9","0","1","2","3"],9:["9","0","1","2","3","4"]};
    const KONTROL_A = {1:["0","1","3","6","7"],2:["1","2","3","7","8"],3:["2","3","4","8","9"],4:["0","3","4","5","9"],5:["0","1","4","5","6"],6:["1","2","5","6","7"],7:["2","3","6","7","8"],8:["3","4","7","8","9"],9:["0","4","5","8","9"]};
    const KONTROL_M = {0:["9","0","1","2","3"],1:["8","9","0","1","2"],2:["3","4","5","6","7"],3:["3","4","5","6","7"],4:["5","6","7","8","9"],5:["0","1","2","3","4"],6:["7","8","9","0","1"],7:["2","3","4","5","6"],8:["1","2","3","4","5"],9:["4","5","6","7","8"]};
    const KONTROL_N = {0:["1","4","6","9"],1:["0","2","5","7"],2:["1","3","6","8"],3:["2","4","7","9"],4:["0","3","5","8"],5:["6","4","1","9"],6:["7","5","0","2"],7:["8","6","3","1"],8:["9","7","4","2"],9:["0","8","5","3"]};

    // ‚îÄ‚îÄ‚îÄ FUNGSI BANTUAN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function digitalRoot(n) {
      let s = n;
      while (s >= 10) {
        s = String(s).split('').reduce((a, b) => parseInt(a) + parseInt(b), 0);
      }
      return s;
    }

    function getInverseDigits(allowed) {
      const all = ["0","1","2","3","4","5","6","7","8","9"];
      return all.filter(d => !allowed.includes(d));
    }

    function generateAll2DFromDigits(digits) {
      const unique = [...new Set(digits)];
      const combos = [];
      for (const a of unique) {
        for (const b of unique) {
          combos.push(a + b);
        }
      }
      return new Set(combos);
    }

    function getAll2D() {
      return Array.from({length: 100}, (_, i) => i.toString().padStart(2, '0'));
    }

    // ‚îÄ‚îÄ‚îÄ RUMUS O (Trigonometri) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function rumusSinCosSliding(result4d) {
      const AB = parseInt(result4d.substring(0, 2), 10);
      const CD = parseInt(result4d.substring(2, 4), 10);
      const degToRad = deg => deg * (Math.PI / 180);
      const value = AB * Math.sin(degToRad(CD));
      const decimalPart = value.toString().split('.')[1] || '0';
      const digits = (decimalPart + '000000').substring(0, 6);
      const pairs = [];
      for (let i = 0; i < 5; i++) {
        if (i + 1 < digits.length) {
          pairs.push(digits[i] + digits[i + 1]);
        } else {
          pairs.push('00');
        }
      }
      return pairs;
    }

    // ‚îÄ‚îÄ‚îÄ KONTROL B‚ÄìY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const get2DSetFromB = (curr) => {
      const as = +curr[0], ekor = +curr[3], dasar = digitalRoot(as + ekor);
      return generateAll2DFromDigits(getInverseDigits(KONTROL_B[dasar] || []));
    };
    const get2DSetFromC = (curr) => {
      const kepala = curr[2];
      return generateAll2DFromDigits(getInverseDigits(KONTROL_C[kepala] || []));
    };
    const get2DSetFromD = (curr) => {
      const kop = +curr[1], kepala = +curr[2], dasar = digitalRoot(kop + kepala);
      return generateAll2DFromDigits(getInverseDigits(KONTROL_D[dasar] || []));
    };
    const get2DSetFromG = (curr) => {
      const kop = +curr[1], kepala = +curr[2], dasar = (kop + kepala) % 10;
      return generateAll2DFromDigits(getInverseDigits(KONTROL_G[dasar] || []));
    };
    const get2DSetFromH = (curr) => {
      const kepala = curr[2];
      return generateAll2DFromDigits(getInverseDigits(KONTROL_H[kepala] || []));
    };
    const get2DSetFromI = (curr) => {
      const ekor = curr[3];
      return generateAll2DFromDigits(getInverseDigits(KONTROL_I[ekor] || []));
    };
    const get2DSetFromJ = (curr) => {
      const as = +curr[0], ekor = +curr[3], dasar = (as + ekor) % 10;
      return generateAll2DFromDigits(getInverseDigits(KONTROL_J[dasar] || []));
    };
    const get2DSetFromK = (curr) => {
      const kepala = +curr[2], ekor = +curr[3], dasar = (kepala + ekor) % 10;
      return generateAll2DFromDigits(getInverseDigits(KONTROL_K[dasar] || []));
    };
    const get2DSetFromR = (curr) => {
      const ekor = curr[3];
      return generateAll2DFromDigits(getInverseDigits(KONTROL_R[ekor] || []));
    };
    const get2DSetFromY = (curr) => {
      const kop = +curr[1], ekor = +curr[3], dasar = (kop + ekor) % 10;
      return generateAll2DFromDigits(getInverseDigits(KONTROL_Y[dasar] || []));
    };
    const get2DSetFromA = (curr) => {
      const kepala = +curr[2], ekor = +curr[3], dasar = digitalRoot(kepala + ekor);
      return generateAll2DFromDigits(getInverseDigits(KONTROL_A[dasar] || []));
    };
    const get2DSetFromM = (curr) => {
      const ekor = curr[3];
      return generateAll2DFromDigits(getInverseDigits(KONTROL_M[ekor] || []));
    };
    const get2DSetFromN = (curr) => {
      const kepala = +curr[2], ekor = +curr[3], selisih = Math.abs(kepala - ekor);
      return generateAll2DFromDigits(getInverseDigits(KONTROL_N[selisih] || []));
    };
    const get2DSetFromO = (curr) => new Set(rumusSinCosSliding(curr));

    // ‚îÄ‚îÄ‚îÄ HITUNG RANGKUMAN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function hitungRampa40(curr4D) {
      const ALL_2D = getAll2D();
      const hitCount = {};

      for (const num of ALL_2D) hitCount[num] = 0;

      const setB = get2DSetFromB(curr4D);
      const setC = get2DSetFromC(curr4D);
      const setD = get2DSetFromD(curr4D);
      const setG = get2DSetFromG(curr4D);
      const setH = get2DSetFromH(curr4D);
      const setI = get2DSetFromI(curr4D);
      const setJ = get2DSetFromJ(curr4D);
      const setK = get2DSetFromK(curr4D);
      const setR = get2DSetFromR(curr4D);
      const setY = get2DSetFromY(curr4D);
      const setA = get2DSetFromA(curr4D);
      const setM = get2DSetFromM(curr4D);
      const setN = get2DSetFromN(curr4D);
      const setO = get2DSetFromO(curr4D);

      const allSets = [setB, setC, setD, setG, setH, setI, setJ, setK, setR, setY, setA, setM, setN, setO];

      for (const s of allSets) {
        for (const num of s) {
          if (hitCount.hasOwnProperty(num)) hitCount[num]++;
        }
      }

      // Identifikasi twin
      const isTwin = (num) => num[0] === num[1];
      const twinNumbers = ALL_2D.filter(isTwin);

      // Angka bersih = hitCount 0, TAPI kecualikan twin
      const angkaBersih = ALL_2D.filter(num => hitCount[num] === 0 && !isTwin(num));
      const out1x = ALL_2D.filter(num => hitCount[num] === 1 && !isTwin(num));
      const out2x = ALL_2D.filter(num => hitCount[num] === 2 && !isTwin(num));
      const out3x = ALL_2D.filter(num => hitCount[num] === 3 && !isTwin(num));
      const out4x = ALL_2D.filter(num => hitCount[num] >= 4 && !isTwin(num));

      // Twin khusus: tampilkan semua twin, kategorikan sesuai hitCount
      const twinBersih = twinNumbers.filter(num => hitCount[num] === 0);
      const twinOut1x = twinNumbers.filter(num => hitCount[num] === 1);
      const twinOut2x = twinNumbers.filter(num => hitCount[num] === 2);
      const twinOut3x = twinNumbers.filter(num => hitCount[num] === 3);
      const twinOut4x = twinNumbers.filter(num => hitCount[num] >= 4);

      // Format akhir: semua angka bersih + twin (dalam satu bagian)
      const finalList = [
        ...angkaBersih,
        ...twinBersih,
        ...twinOut1x,
        ...twinOut2x,
        ...twinOut3x,
        ...twinOut4x
      ].sort();

      return {
        finalList,
        angkaBersih,
        out1x, out2x, out3x, out4x,
        twinBersih, twinOut1x, twinOut2x, twinOut3x, twinOut4x
      };
    }

    // ‚îÄ‚îÄ‚îÄ TAMPILKAN & SIMPAN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function tampilkanHasilRampa40(hasil) {
      const text = hasil.finalList.length ? hasil.finalList.join('*') + '#' : '‚ùå Tidak ada angka.';
      document.getElementById('final-result').textContent = text;
      document.getElementById('hasil-rampa40').style.display = 'block';

      // Simpan ke localStorage untuk fitur5 (ngai)
      const savedData = {
        timestamp: new Date().toISOString(),
        resultsHTML: document.querySelector('#hasil-rampa40').outerHTML
      };
      localStorage.setItem('fitur2_data', JSON.stringify(savedData));
    }

    // ‚îÄ‚îÄ‚îÄ FUNGSI LAINNYA (FIREBASE, PASANG EVENT) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showMessage(msg) {
      document.getElementById('status').textContent = msg;
    }

    async function loadMarketData(marketKey) {
      showMessage("Mengambil data " + marketKey + "...");
      const marketRef = ref(db, 'fitur1/markets/' + marketKey);
      try {
        const snapshot = await new Promise((resolve, reject) => {
          const timeout = setTimeout(() => reject(new Error("Timeout")), 5000);
          onValue(marketRef, (snap) => {
            clearTimeout(timeout);
            resolve(snap);
          }, (err) => {
            clearTimeout(timeout);
            reject(err);
          });
        });

        const data = snapshot.val();
        const results = Array.isArray(data) ? data : (data?.results || []);

        if (!Array.isArray(results) || results.length < 2) {
          showMessage("‚ö†Ô∏è Data " + marketKey + " tidak cukup (min. 2 hasil).");
          document.getElementById('prev-result').value = '';
          document.getElementById('curr-result').value = '';
          return;
        }

        const prev4D = results[results.length - 2] || '';
        const curr4D = results[results.length - 1] || '';

        document.getElementById('prev-result').value = prev4D;
        document.getElementById('curr-result').value = curr4D;
        showMessage("‚úÖ Data " + marketKey + " dimuat.");
      } catch (err) {
        console.error("Gagal muat ", err);
        showMessage("‚ùå Gagal muat data " + marketKey);
      }
    }

    document.getElementById('market-select').addEventListener('change', function () {
      const market = this.value;
      if (market) {
        loadMarketData(market);
      } else {
        document.getElementById('prev-result').value = '';
        document.getElementById('curr-result').value = '';
        showMessage("");
      }
    });

    document.getElementById('btn-generate').addEventListener('click', function () {
      const prev = document.getElementById('prev-result').value.trim();
      const curr = document.getElementById('curr-result').value.trim();
      const prevDate = document.getElementById('prev-date').value.trim();
      const currDate = document.getElementById('curr-date').value.trim();

      if (!curr || curr.length !== 4) {
        showMessage("‚ùå 4D Sekarang harus 4 digit.");
        return;
      }
      if (!prevDate || !currDate) {
        showMessage("‚ùå Tanggal harus diisi.");
        return;
      }

      // Jalankan logika rampa40 hanya berdasarkan curr (sesuai standar)
      const hasil = hitungRampa40(curr);
      tampilkanHasilRampa40(hasil);
      showMessage("‚úÖ Ramp40 selesai.");
    });
  </script>
</body>
</html>
