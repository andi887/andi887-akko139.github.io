
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>nota</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 15px;
      background: #f9f9f9;
      color: #333;
    }
    h1 {
      text-align: center;
      font-size: 1.4em;
      margin: 0 0 16px;
    }
    .back-home {
      text-align: center;
      margin: 12px 0;
    }
    .back-home a {
      display: inline-block;
      padding: 10px 20px;
      background: #4285f4;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-weight: bold;
      font-size: 0.95em;
    }
    .back-home a:hover {
      background: #3367d6;
    }
    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin: 6px 0;
      font-weight: bold;
    }
    #btn-cloning { background: #03A9F4; color: white; }
    #btn-hapus-cloning { background: #FF9800; color: black; }
    #btn-simpan-semua { background: #4CAF50; color: white; }
    #btn-hapus-semua { background: #f44336; color: white; }
    .btn:hover { opacity: 0.9; }

    .nota-box {
      background: white;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      position: relative;
    }
    .nota-box h2 {
      margin: 0 0 8px;
      font-size: 1.1em;
      color: #2c3e50;
    }
    select.market-select {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.95em;
    }
    .nota-row {
      width: 100%;
      height: 80px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-family: Arial, monospace;
      font-size: 1em;
      resize: vertical;
      box-sizing: border-box;
      margin-bottom: 8px;
    }
    .box-actions {
      display: flex;
      gap: 6px;
    }
    .box-btn {
      flex: 1;
      padding: 6px;
      font-size: 0.85em;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-copy { background: #e0e0e0; }
    .btn-edit { background: #9C27B0; color: white; }
    .btn-delete { background: #f44336; color: white; }
    .btn-copy:hover { background: #d0d0d0; }
    .btn-edit:hover { background: #7B1FA2; }
    .btn-delete:hover { background: #d32f2f; }

    .status {
      text-align: center;
      color: #e74c3c;
      min-height: 20px;
      margin: 8px 0;
      font-size: 0.95em;
    }
    .info-time {
      font-size: 0.85em;
      color: #555;
      margin-top: 4px;
      text-align: right;
    }
  </style>
</head>
<body>
  <h1>ğŸ“ nota</h1>

  <div class="back-home">
    <a href="index.html">ğŸ”™ Kembali ke Beranda</a>
  </div>

  <button class="btn" id="btn-cloning">â• Cloning</button>
  <button class="btn" id="btn-hapus-cloning">ğŸ—‘ï¸ Hapus Semua Cloning</button>
  <button class="btn" id="btn-simpan-semua">ğŸ’¾ Simpan ke Firebase</button>
  <button class="btn" id="btn-hapus-semua">âŒ Hapus Semua (Firebase)</button>

  <div id="nota-container"></div>
  <div class="status" id="status"></div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, remove, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyALc-1SYjzRUcB-Ws01rab1mxlmcv2e6dA",
      authDomain: "nomoromosse.firebaseapp.com",
      databaseURL: "https://nomoromosse-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "nomoromosse",
      storageBucket: "nomoromosse.firebasestorage.app",
      messagingSenderId: "985183830784",
      appId: "1:985183830784:web:fae21bdb94c1f0103769e5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const MARKETS = ["Cambodia", "Sidney", "China", "Japan", "SGP", "Taiwan", "Hongkong"];
    let instanceCounter = 0;

    function showMessage(msg, isError = false) {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.style.color = isError ? '#e74c3c' : '#27ae60';
      setTimeout(() => el.textContent = '', 3000);
    }

    function getFormattedDate() {
      const now = new Date();
      const day = String(now.getDate()).padStart(2, '0');
      const month = String(now.getMonth() + 1).padStart(2, '0');
      return `${day}/${month}`;
    }

    async function copyToClipboard(text, btn) {
      if (!text.trim()) {
        const orig = btn.textContent;
        btn.textContent = 'Kosong';
        setTimeout(() => btn.textContent = orig, 1000);
        return;
      }
      try {
        await navigator.clipboard.writeText(text);
        const orig = btn.textContent;
        btn.textContent = 'âœ…';
        setTimeout(() => btn.textContent = orig, 1200);
      } catch (err) {
        btn.textContent = 'âš ï¸';
        setTimeout(() => btn.textContent = 'ğŸ“‹ Salin', 1000);
      }
    }

    function createNotaInstance(isOriginal = false) {
      const id = 'nota-' + Date.now() + '-' + instanceCounter++;
      const box = document.createElement('div');
      box.className = 'nota-box';
      box.id = id;

      const marketSelect = document.createElement('select');
      marketSelect.className = 'market-select';
      MARKETS.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = m;
        marketSelect.appendChild(opt);
      });

      const row1 = document.createElement('textarea');
      row1.className = 'nota-row';
      row1.placeholder = 'Baris 1: Angka/hasil utama...';

      const row2 = document.createElement('textarea');
      row2.className = 'nota-row';
      row2.placeholder = 'Baris 2: Keterangan tambahan...';

      const actions = document.createElement('div');
      actions.className = 'box-actions';

      const btnCopy = document.createElement('button');
      btnCopy.className = 'box-btn btn-copy';
      btnCopy.textContent = 'ğŸ“‹ Salin';
      btnCopy.onclick = () => {
        const text = `${row1.value}\n${row2.value}`.trim();
        copyToClipboard(text, btnCopy);
      };

      const btnEdit = document.createElement('button');
      btnEdit.className = 'box-btn btn-edit';
      btnEdit.textContent = 'âœï¸ Edit';
      btnEdit.onclick = () => {
        row1.readOnly = !row1.readOnly;
        row2.readOnly = !row2.readOnly;
        btnEdit.textContent = row1.readOnly ? 'âœï¸ Edit' : 'ğŸ”’ Kunci';
      };
      row1.readOnly = false;
      row2.readOnly = false;

      const btnDelete = document.createElement('button');
      btnDelete.className = 'box-btn btn-delete';
      btnDelete.textContent = 'ğŸ—‘ï¸ Hapus';
      btnDelete.onclick = () => {
        if (isOriginal) {
          showMessage('âš ï¸ Tidak bisa hapus instans utama.', true);
          return;
        }
        if (confirm('Hapus instans ini?')) {
          box.remove();
        }
      };

      actions.appendChild(btnCopy);
      actions.appendChild(btnEdit);
      actions.appendChild(btnDelete);

      box.appendChild(marketSelect);
      box.appendChild(row1);
      box.appendChild(row2);
      box.appendChild(actions);

      if (isOriginal) {
        btnDelete.style.display = 'none';
      }

      return box;
    }

    function cloneNota() {
      const container = document.getElementById('nota-container');
      const clone = createNotaInstance(false);
      container.appendChild(clone);
      showMessage('âœ… Instans baru ditambahkan.');
    }

    function removeAllClones() {
      const container = document.getElementById('nota-container');
      const children = container.children;
      while (children.length > 1) {
        container.removeChild(children[1]);
      }
      showMessage('ğŸ§¹ Semua cloning dihapus.');
    }

    async function saveAllToFirebase() {
      const container = document.getElementById('nota-container');
      const entries = [];
      const now = getFormattedDate();

      for (let box of container.children) {
        const select = box.querySelector('.market-select');
        const row1 = box.querySelector('.nota-row:nth-of-type(1)');
        const row2 = box.querySelector('.nota-row:nth-of-type(2)');

        if (!select || !row1 || !row2) continue;

        entries.push({
          market: select.value,
          baris1: row1.value.trim(),
          baris2: row2.value.trim(),
          date: now
        });
      }

      if (entries.length === 0) {
        showMessage('âš ï¸ Tidak ada data untuk disimpan.', true);
        return;
      }

      const saveId = 'nota-' + Date.now();
      const saveRef = ref(db, `generator_2d/nota/${saveId}`);
      try {
        await set(saveRef, { entries, savedAt: Date.now() });
        showMessage('âœ… Semua catatan tersimpan ke Firebase.');
      } catch (err) {
        console.error('Firebase save error:', err);
        showMessage('âŒ Gagal simpan ke Firebase.', true);
      }
    }

    async function removeAllFromFirebase() {
      if (!confirm('Yakin hapus SEMUA data nota di Firebase?')) return;
      try {
        await remove(ref(db, 'generator_2d/nota'));
        showMessage('ğŸ—‘ï¸ Semua data Firebase dihapus.');
        // Reset UI
        document.getElementById('nota-container').innerHTML = '';
        loadSavedNotes(); // Muat ulang â†’ akan tampilkan instans kosong
      } catch (err) {
        console.error('Firebase remove error:', err);
        showMessage('âŒ Gagal menghapus data Firebase.', true);
      }
    }

    // â”€â”€â”€ ğŸ”‘ FUNGSI BARU: MUAT DATA DARI FIREBASE SAAT HALAMAN DIBUKA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadSavedNotes() {
      const container = document.getElementById('nota-container');
      container.innerHTML = '';

      try {
        const dbRef = ref(db, 'generator_2d/nota');
        const snapshot = await get(dbRef);

        if (!snapshot.exists()) {
          const firstInstance = createNotaInstance(true);
          container.appendChild(firstInstance);
          return;
        }

        const data = snapshot.val();
        let latestEntry = null;
        let latestKey = null;

        for (const key in data) {
          if (data[key].savedAt && (!latestEntry || data[key].savedAt > latestEntry.savedAt)) {
            latestEntry = data[key];
            latestKey = key;
          }
        }

        if (latestEntry && latestEntry.entries && Array.isArray(latestEntry.entries)) {
          latestEntry.entries.forEach((entry, index) => {
            const box = createNotaInstance(index === 0);
            const select = box.querySelector('.market-select');
            const row1 = box.querySelector('.nota-row:nth-of-type(1)');
            const row2 = box.querySelector('.nota-row:nth-of-type(2)');

            if (MARKETS.includes(entry.market)) {
              select.value = entry.market;
            }
            row1.value = entry.baris1 || '';
            row2.value = entry.baris2 || '';

            container.appendChild(box);
          });
          showMessage(`âœ… Memuat ${latestEntry.entries.length} instans dari Firebase.`);
        } else {
          const firstInstance = createNotaInstance(true);
          container.appendChild(firstInstance);
        }
      } catch (err) {
        console.error('Gagal muat data dari Firebase:', err);
        showMessage('âš ï¸ Gagal muat data dari Firebase.', true);
        const firstInstance = createNotaInstance(true);
        container.appendChild(firstInstance);
      }
    }

    // â”€â”€â”€ Inisialisasi â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function init() {
      loadSavedNotes(); // ğŸ”¥ Muat otomatis saat halaman dibuka

      document.getElementById('btn-cloning').addEventListener('click', cloneNota);
      document.getElementById('btn-hapus-cloning').addEventListener('click', removeAllClones);
      document.getElementById('btn-simpan-semua').addEventListener('click', saveAllToFirebase);
      document.getElementById('btn-hapus-semua').addEventListener('click', removeAllFromFirebase);
    }

    init();
  </script>
</body>
</html>
