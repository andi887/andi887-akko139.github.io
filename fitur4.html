
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>kamar</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 12px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    .panel {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 16px;
      margin-bottom: 20px;
    }

    h1 {
      text-align: center;
      font-size: 1.4em;
      margin: 0 0 20px;
      color: #333;
    }

    .back-home {
      text-align: center;
      margin: 12px 0;
    }
    .back-home a {
      display: inline-block;
      padding: 10px 20px;
      background: #4285f4;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-weight: bold;
      font-size: 0.95em;
    }
    .back-home a:hover {
      background: #3367d6;
    }

    .cloning-controls {
      text-align: center;
      margin: 12px 0;
    }
    .cloning-controls button {
      padding: 10px 16px;
      background: #673ab7;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
    .cloning-controls button:hover {
      background: #512da8;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .panel-title {
      font-weight: bold;
      font-size: 1.1em;
      color: #2c3e50;
    }
    .market-select {
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 0.95em;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      margin: 12px 0 20px;
    }
    .action-buttons button {
      flex: 1;
      padding: 10px;
      font-size: 14px;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn-save { background: #34a853; color: white; }
    .btn-save:hover { background: #2d8f47; }
    .btn-clear { background: #ea4335; color: white; }
    .btn-clear:hover { background: #d33426; }
    .btn-delete-panel { background: #f57c00; color: white; }
    .btn-delete-panel:hover { background: #e65100; }

    .input-group {
      margin: 12px 0;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 6px;
      color: #555;
      font-size: 0.95em;
    }
    input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
    }

    button.btn-hitung {
      width: 100%;
      padding: 14px;
      background: #673ab7;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin: 16px 0;
    }
    button.btn-hitung:active {
      background: #512da8;
      transform: scale(0.99);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 16px;
    }
    th, td {
      padding: 12px 8px;
      text-align: center;
      border: 1px solid #ddd;
    }
    th {
      background-color: #f8f9fa;
      color: #333;
    }
    .rumus-tag {
      color: #d32f2f;
      font-weight: bold;
      font-size: 15px;
    }

    @media (max-width: 480px) {
      .panel { padding: 12px; }
      .panel-header { flex-direction: column; align-items: flex-start; gap: 8px; }
      .action-buttons { flex-direction: column; }
      .action-buttons button { width: 100%; }
      th, td { padding: 10px 6px; font-size: 15px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üî¢ kamar</h1>

    <div class="back-home">
      <a href="index.html">üîô Kembali ke Beranda</a>
    </div>

    <div class="cloning-controls">
      <button id="btn-tambah-kamar">‚ûï Tambah Kamar</button>
    </div>

    <div id="panels-container">
      <!-- Panel akan dibuat dinamis -->
    </div>
  </div>

  <script>
    // === KONFIGURASI ===
    const MARKETS = ["cambodia", "sidney", "china", "japan", "sgp", "taiwan", "hongkong"];
    let panelCount = 0;
    const activePanels = new Map(); // market ‚Üí panelId

    // === DATA SHIO (TIDAK BERUBAH) ===
    const shioAngka = {
      1: [1,13,25,37,49,61,73,85,97],
      2: [2,14,26,38,50,62,74,86,98],
      3: [3,15,27,39,51,63,75,87,99],
      4: [4,16,28,40,52,64,76,88],
      5: [5,17,29,41,53,65,77,89],
      6: [6,18,30,42,54,66,78,90],
      7: [7,19,31,43,55,67,79,91],
      8: [8,20,32,44,56,68,80,92],
      9: [9,21,33,45,57,69,81,93],
      10: [10,22,34,46,58,70,82,94],
      11: [11,23,35,47,59,71,83,95],
      12: [12,24,36,48,60,72,84,96]
    };

    // === FUNGSI BANTU (TIDAK BERUBAH) ===
    function getIndex(angka) { return (angka + 5) % 10; }
    function angkaKeShio(n) { n = n % 12; return n === 0 ? 12 : n; }

    function hitungDasar2D(duaD) {
      let total = duaD < 10 ? duaD : parseInt(duaD.toString()[0]) + parseInt(duaD.toString()[1]);
      while (total >= 10) total = String(total).split('').reduce((sum, d) => sum + parseInt(d), 0);
      return total === 0 ? 9 : total;
    }

    // === LOGIKA RUMUS (TIDAK BERUBAH) ===
    function hitungKamarLemah(tglSeb, tglSkr, empatDLalu, empatDSkr) {
      const kamarRumus = {};
      for (let i = 1; i <= 12; i++) kamarRumus[i] = new Set();

      let str4D = empatDSkr.toString().padStart(4, '0');
      const AS = +str4D[0], KOP = +str4D[1], KEPALA = +str4D[2], EKOR = +str4D[3], duaD = KEPALA * 10 + EKOR;
      let str4DLalu = empatDLalu.toString().padStart(4, '0');
      const AS_Lalu = +str4DLalu[0];

      kamarRumus[angkaKeShio(tglSkr)].add(1);
      kamarRumus[angkaKeShio(tglSkr + 7)].add(2);
      kamarRumus[angkaKeShio(tglSeb + tglSkr)].add(3);
      kamarRumus[angkaKeShio(hitungDasar2D(duaD) + tglSkr)].add(4);
      kamarRumus[angkaKeShio(100 - duaD)].add(5);
      kamarRumus[angkaKeShio(99 - duaD)].add(6);
      kamarRumus[angkaKeShio(getIndex(AS) * 10 + getIndex(KOP))].add(7);
      kamarRumus[angkaKeShio(getIndex(KEPALA) * 10 + getIndex(EKOR))].add(8);
      kamarRumus[angkaKeShio(AS * 10 + KOP)].add(9);
      kamarRumus[angkaKeShio(KOP * 10 + KEPALA)].add(10);

      const digitKepala = KEPALA.toString();
      for (let s = 1; s <= 12; s++) {
        if (!shioAngka[s].some(num => num.toString().padStart(2, '0').includes(digitKepala)))
          kamarRumus[s].add(11);
      }

      const digitEkor = EKOR.toString();
      for (let s = 1; s <= 12; s++) {
        if (!shioAngka[s].some(num => num.toString().padStart(2, '0').includes(digitEkor)))
          kamarRumus[s].add(12);
      }

      kamarRumus[angkaKeShio(AS * 10 + EKOR)].add(13);
      kamarRumus[angkaKeShio(getIndex(AS_Lalu) * 10 + getIndex(AS))].add(14);

      // üîπ Rumus 15, 16, 17
      let str4DLalu6 = empatDLalu.toString().padStart(4, '0');
      let str4DSkr6 = empatDSkr.toString().padStart(4, '0');
      const combined8 = str4DLalu6 + str4DSkr6;
      const result6 = combined8.slice(-6).padStart(6, '0');

      let sum15 = 0;
      for (const char of result6) sum15 += parseInt(char, 10);
      sum15 += 9;
      const target2D_15 = String(sum15).padStart(2, '0').slice(-2);
      const angka15 = parseInt(target2D_15, 10);
      kamarRumus[angkaKeShio(angka15)].add(15);

      const ac2D = result6[0] + result6[2];
      const angka16 = parseInt(ac2D, 10);
      kamarRumus[angkaKeShio(angka16)].add(16);

      let sum17 = 0;
      for (const char of result6) sum17 += parseInt(char, 10);
      const mod17 = sum17 % 12;
      const shio17 = mod17 === 0 ? 12 : mod17;
      kamarRumus[shio17].add(17);

      return kamarRumus;
    }

    // === RENDER TABEL KOSONG ===
    function buatTabelKamar(containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = `
        <table>
          <thead><tr><th>Kamar</th><th>Rumus Lemah</th></tr></thead>
          <tbody id="kamar-body-${containerId}"></tbody>
        </table>
      `;
      const tbody = document.getElementById(`kamar-body-${containerId}`);
      for (let i = 1; i <= 12; i++) {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${i}</td><td id="rumus-${i}-${containerId}">‚Äî</td>`;
        tbody.appendChild(row);
      }
    }

    // === TAMPILKAN HASIL ===
    function tampilkanKamarLemah(kamarRumus, containerId) {
      for (let i = 1; i <= 12; i++) {
        const cell = document.getElementById(`rumus-${i}-${containerId}`);
        const list = Array.from(kamarRumus[i]).sort((a, b) => a - b);
        cell.innerHTML = list.length === 0 ? "‚Äî" : `<span class="rumus-tag">${list.join(",")}</span>`;
      }
    }

    // === PENYIMPANAN PER MARKET ===
    function getStorageKey(market) {
      return `kamar_data_${market}`;
    }

    function simpanKeStorage(market, data) {
      localStorage.setItem(getStorageKey(market), JSON.stringify(data));
    }

    function muatDariStorage(market) {
      const saved = localStorage.getItem(getStorageKey(market));
      if (saved) {
        try {
          return JSON.parse(saved);
        } catch (e) {
          console.error('Gagal parse data untuk market:', market, e);
        }
      }
      return null;
    }

    // === BUAT PANEL BARU ===
    function buatPanel(market = 'cambodia') {
      panelCount++;
      const panelId = `panel-${panelCount}`;
      const panelEl = document.createElement('div');
      panelEl.className = 'panel';
      panelEl.id = panelId;

      panelEl.innerHTML = `
        <div class="panel-header">
          <div class="panel-title">Kamar ${panelCount}</div>
          <select class="market-select">
            ${MARKETS.map(m => `<option value="${m}" ${m === market ? 'selected' : ''}>${m.charAt(0).toUpperCase() + m.slice(1)}</option>`).join('')}
          </select>
        </div>

        <div class="input-group">
          <label>Tanggal Pemutaran Sebelumnya</label>
          <input type="text" data-field="tanggalSebelum" placeholder="Contoh: 10" inputmode="numeric" />
        </div>
        <div class="input-group">
          <label>Tanggal Pemutaran Sekarang</label>
          <input type="text" data-field="tanggalSekarang" placeholder="Contoh: 11" inputmode="numeric" />
        </div>
        <div class="input-group">
          <label>4D Result Sebelumnya</label>
          <input type="text" data-field="result4DLalu" placeholder="Contoh: 4796" inputmode="numeric" maxlength="4" />
        </div>
        <div class="input-group">
          <label>4D Result Sekarang</label>
          <input type="text" data-field="result4D" placeholder="Contoh: 7890" inputmode="numeric" maxlength="4" />
        </div>

        <button class="btn-hitung" onclick="window.handleHitung('${panelId}')">Terapkan Semua Rumus</button>

        <div class="action-buttons">
          <button class="btn-save" onclick="window.handleSimpan('${panelId}')">üíæ Simpan</button>
          <button class="btn-clear" onclick="window.handleHapusData('${panelId}')">üóëÔ∏è Hapus Data</button>
          <button class="btn-delete-panel" onclick="window.handleHapusPanel('${panelId}')">‚ùå Hapus Panel</button>
        </div>

        <div id="tabel-kamar-${panelId}"></div>
      `;

      document.getElementById('panels-container').appendChild(panelEl);
      buatTabelKamar(`tabel-kamar-${panelId}`);

      // Pasang event ganti market
      const select = panelEl.querySelector('.market-select');
      select.onchange = () => {
        const oldMarket = [...activePanels.entries()].find(([m, id]) => id === panelId)?.[0];
        const newMarket = select.value;
        if (oldMarket && oldMarket !== newMarket) {
          activePanels.delete(oldMarket);
          activePanels.set(newMarket, panelId);
          // Muat data market baru
          const data = muatDariStorage(newMarket);
          if (data) {
            ['tanggalSebelum','tanggalSekarang','result4DLalu','result4D'].forEach(f => {
              const input = panelEl.querySelector(`[data-field="${f}"]`);
              if (input) input.value = data[f] || '';
            });
            if (data.hasil) {
              setTimeout(() => {
                for (let i = 1; i <= 12; i++) {
                  const cell = document.getElementById(`rumus-${i}-${panelId}`);
                  if (cell && data.hasil[i]) {
                    cell.innerHTML = `<span class="rumus-tag">${data.hasil[i]}</span>`;
                  }
                }
              }, 50);
            }
          } else {
            // Kosongkan jika tidak ada data
            ['tanggalSebelum','tanggalSekarang','result4DLalu','result4D'].forEach(f => {
              const input = panelEl.querySelector(`[data-field="${f}"]`);
              if (input) input.value = '';
            });
            buatTabelKamar(`tabel-kamar-${panelId}`);
          }
        }
      };

      activePanels.set(market, panelId);

      // Muat data awal
      const data = muatDariStorage(market);
      if (data) {
        ['tanggalSebelum','tanggalSekarang','result4DLalu','result4D'].forEach(f => {
          const input = panelEl.querySelector(`[data-field="${f}"]`);
          if (input) input.value = data[f] || '';
        });
        if (data.hasil) {
          setTimeout(() => {
            for (let i = 1; i <= 12; i++) {
              const cell = document.getElementById(`rumus-${i}-${panelId}`);
              if (cell && data.hasil[i]) {
                cell.innerHTML = `<span class="rumus-tag">${data.hasil[i]}</span>`;
              }
            }
          }, 50);
        }
      }
    }

    // === HANDLER GLOBAL ===
    window.handleHitung = (panelId) => {
      const getVal = (f) => document.querySelector(`#${panelId} [data-field="${f}"]`).value.trim();
      const seb = getVal('tanggalSebelum');
      const skr = getVal('tanggalSekarang');
      const laluStr = getVal('result4DLalu');
      const skr4DStr = getVal('result4D');

      if (!seb || !skr || !laluStr || !skr4DStr) {
        alert("Harap isi semua kolom.");
        return;
      }

      const tglSeb = parseInt(seb, 10);
      const tglSkr = parseInt(skr, 10);
      const empatDLalu = parseInt(laluStr, 10);
      const empatDSkr = parseInt(skr4DStr, 10);

      if (isNaN(tglSeb) || isNaN(tglSkr) || tglSeb < 1 || tglSeb > 31 || tglSkr < 1 || tglSkr > 31) {
        alert("Tanggal harus angka 1‚Äì31.");
        return;
      }
      if (isNaN(empatDLalu) || isNaN(empatDSkr) || empatDLalu < 0 || empatDLalu > 9999 || empatDSkr < 0 || empatDSkr > 9999) {
        alert("4D harus angka 0‚Äì9999.");
        return;
      }

      const hasil = hitungKamarLemah(tglSeb, tglSkr, empatDLalu, empatDSkr);
      tampilkanKamarLemah(hasil, panelId);

      // Simpan otomatis
      const market = document.querySelector(`#${panelId} .market-select`).value;
      const data = {
        tanggalSebelum: seb,
        tanggalSekarang: skr,
        result4DLalu: laluStr,
        result4D: skr4DStr,
        hasil: {}
      };
      for (let i = 1; i <= 12; i++) {
        const cell = document.getElementById(`rumus-${i}-${panelId}`);
        if (cell && cell.textContent !== "‚Äî") {
          data.hasil[i] = cell.textContent;
        }
      }
      simpanKeStorage(market, data);
    };

    window.handleSimpan = (panelId) => {
      const seb = document.querySelector(`#${panelId} [data-field="tanggalSebelum"]`).value.trim();
      const skr = document.querySelector(`#${panelId} [data-field="tanggalSekarang"]`).value.trim();
      const lalu = document.querySelector(`#${panelId} [data-field="result4DLalu"]`).value.trim();
      const skr4D = document.querySelector(`#${panelId} [data-field="result4D"]`).value.trim();

      if (!seb || !skr || !lalu || !skr4D) {
        alert("‚ö†Ô∏è Lengkapi semua input terlebih dahulu.");
        return;
      }

      const market = document.querySelector(`#${panelId} .market-select`).value;
      const data = {
        tanggalSebelum: seb,
        tanggalSekarang: skr,
        result4DLalu: lalu,
        result4D: skr4D,
        hasil: {}
      };
      for (let i = 1; i <= 12; i++) {
        const cell = document.getElementById(`rumus-${i}-${panelId}`);
        if (cell && cell.textContent !== "‚Äî") {
          data.hasil[i] = cell.textContent;
        }
      }
      simpanKeStorage(market, data);
      alert("‚úÖ Data berhasil disimpan ke localStorage!");
    };

    window.handleHapusData = (panelId) => {
      if (confirm("Yakin hapus data panel ini?")) {
        const market = document.querySelector(`#${panelId} .market-select`).value;
        localStorage.removeItem(getStorageKey(market));
        ['tanggalSebelum','tanggalSekarang','result4DLalu','result4D'].forEach(f => {
          const input = document.querySelector(`#${panelId} [data-field="${f}"]`);
          if (input) input.value = '';
        });
        buatTabelKamar(`tabel-kamar-${panelId}`);
        alert("üóëÔ∏è Data panel ini dihapus.");
      }
    };

    window.handleHapusPanel = (panelId) => {
      if (confirm("Yakin hapus seluruh panel ini?")) {
        const market = document.querySelector(`#${panelId} .market-select`).value;
        localStorage.removeItem(getStorageKey(market));
        const el = document.getElementById(panelId);
        if (el) el.remove();
        activePanels.delete(market);
      }
    };

    // === INIT ===
    document.getElementById('btn-tambah-kamar').onclick = () => {
      if (activePanels.size >= MARKETS.length) {
        alert("Maksimal 7 market telah tercapai.");
        return;
      }
      const used = new Set(activePanels.keys());
      const nextMarket = MARKETS.find(m => !used.has(m)) || 'cambodia';
      buatPanel(nextMarket);
    };

    document.addEventListener('DOMContentLoaded', () => {
      // Buat panel pertama
      buatPanel('cambodia');
    });
  </script>
</body>
</html>
